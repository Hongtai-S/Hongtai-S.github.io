---
layout:     post
title:      恶意软件分析（二）：AveMaria恶意软件分析
subtitle:   .net恶意软件分析
date:       2021-11-04
author:     Hongtai S
header-img: img/17.jpg
catalog: true
tags:
    - 逆向
    - 二进制
    - 恶意代码分析
---
# 样本基本信息

样本文件名称：677ea3bde24fd6ccb8945d584eab801c52309dd46f98b2ea6f433e173379c91a.bin

样本MD5：3af01f67b945e599be8d7b1855276374

样本SHA-1：61e98608a7bf040f63458c9f26f56874c7a09d2f

样本SHA-256：677ea3bde24fd6ccb8945d584eab801c52309dd46f98b2ea6f433e173379c91a

样本文件类型：使用exeinfope查看文件类型：

![1.png](https://s2.loli.net/2022/01/26/AXqd2lvg8OYGhME.png)

样本为.net程序，使用C#编写

# 样本行为分析

## 解密资源节

样本中包含两个重要的资源节，分别是RecipeBook.Data.Reciepes.resource和RecipeBook.Properties.Resources.resources

![2.png](https://s2.loli.net/2022/01/26/4usGDKdtcqj6Qx3.png)
![3.png](https://s2.loli.net/2022/01/26/fgFK13XTzUQEeIq.png)

在程序中有一段代码访问了RecipeBook.Data.Reciepes.resource资源节并进行解密

访问资源节代码如下

![4.png](https://s2.loli.net/2022/01/26/E65r2wtjHcD1szp.png)

解密资源节代码如下

![5.png](https://s2.loli.net/2022/01/26/V6mPjtRbgvGedHU.png)

解密后的数据开头是4D5A，将其从内存中dump出来得到新的PE文件

![6.png](https://s2.loli.net/2022/01/26/bACJOTWPsqcIZ8w.png)

新的PE文件仍然是.net的dll文件

![7.png](https://s2.loli.net/2022/01/26/QN8UdbiVKGaMzIw.png)

之后程序加载了这个dll并获取了第1个导出函数

![8.png](https://s2.loli.net/2022/01/26/RPoHr79kGe8FSb4.png)

查看导出的dll，看到函数名都被混淆了

![9.png](https://s2.loli.net/2022/01/26/PyphVJ3IeEg2YMx.png)

使用de4dot解混淆后能够看到其函数名

![10.png](https://s2.loli.net/2022/01/26/9RBCZGqYKdu8aMV.png)

找到第一个导出函数，能够看到其调用的其中一个函数包含大量的异或操作，初步判定其解密了原程序的RecipeBook.Data.Reciepes.resource资源节

![11.png](https://s2.loli.net/2022/01/26/CgPzcW592HmBtou.png)

在源代码的基础上dump出解密的资源节，得到了一个payload文件，是c++编写的。

![12.png](https://s2.loli.net/2022/01/26/PSgp4QkcYod8xa7.png)

总结上述流程如下图所示：

![32.png](https://s2.loli.net/2022/01/26/w981nakFKvj5IYr.png)

## 创建子进程

创建子进程image.exe、powershell、schtasks.exe。

![13.png](https://s2.loli.net/2022/01/26/b1AuriVyoGmCPfS.png)

## 建立TCP连接

与185.19.85.155:5200建立TCP连接

![14.png](https://s2.loli.net/2022/01/26/YGTvnbHcFoNuI6W.png)

# 样本功能分析

## 1. 连接指定IP

相关函数：sub_40EE9A

![15.png](https://s2.loli.net/2022/01/26/FDCPljkyqoUgmRt.png)

socket()创建一个网络套接字，gethostbyname()获取主机地址信息，connect()与指定的套接字建立连接。

## 2. 打开指定文件或文件夹

相关函数：sub_402650

![16.png](https://s2.loli.net/2022/01/26/BAKJtprzaiwjPHL.png)

ShellExecuteW()函数对指定的文件或文件夹进行“open”操作。

## 3. 向指定套接字发送数据

相关函数：sub_4055A5

![17.png](https://s2.loli.net/2022/01/26/zYHpXGKRax8ow7u.png)

send()函数向指定的套接字发送数据

## 4. 从指定url下载并执行文件

相关函数：sub_4027D3

![18.png](https://s2.loli.net/2022/01/26/1HDBUn3xFOcRImy.png)

URLDownloadToFileW()从指定url下载文件，ShellExecuteW()执行该文件。

## 5. 击键记录

相关函数：sub_40882F、sub_4089D5

![19.png](https://s2.loli.net/2022/01/26/Gt3OMeRVC29Xmgv.png)
![20.png](https://s2.loli.net/2022/01/26/yXi8E97YJwrTBFa.png)

创建“c:\\windows\\system32\\user32.dll”文件并使用SetWindowsHookExA()设置hook，CallNextHookEx()调用下一个hook，GetAsyncKeyState(16)获取shift键状态。

## 6. 隐藏指定Windows账号

相关函数：sub_40E3FA

![21.png](https://s2.loli.net/2022/01/26/CXoNMbuW9pGeR4Y.png)

创建注册表键"SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList"并将指定用户的值设为0，隐藏该用户。

## 7. 获取浏览器保存的账号和密码信息

相关函数：sub_40C1B2

![22.png](https://s2.loli.net/2022/01/26/YM5ELdl4KprZ6SO.png)

"\User Data\Default\Login Data"中存放了浏览器保存的账号密码信息。

## 8. 获取前台窗口的标题

相关函数：sub_4047EA

![23.png](https://s2.loli.net/2022/01/26/toSihOUlCs9ZpqQ.png)

GetForegroundWindow()获取前台窗口句柄，GetWindowTextW()获取指定窗口的标题。

## 9. 查看目录是否有效

相关函数：sub_4028CF

![24.png](https://s2.loli.net/2022/01/26/HpiQFhRaSzm1UcC.png)
![25.png](https://s2.loli.net/2022/01/26/s3xBGUCLvYActn2.png)

PathFileExistsW（）查看是否是有效路径，CreateFileW()创建指定文件。

## 10. 删除指定文件

相关函数：sub_40FF0B

![26.png](https://s2.loli.net/2022/01/26/VBh3cHFQRo5eMqA.png)

## 11. 关闭指定进程

相关函数：sub_407AD0

![27.png](https://s2.loli.net/2022/01/26/9fCX6lmEYeRGBPy.png)

OpenProcess()打开指定进程，TerminateProcess()终止指定进程。

## 12. 获取主机中运行的进程的路径

相关函数：sub_410D24

![28.png](https://s2.loli.net/2022/01/26/73eSTZVjXupdL5t.png)
![29.png](https://s2.loli.net/2022/01/26/qKz7WCOQZMb9avX.png)

CreateToolhelp32Snapshot()创建进程快照，Process32FirstW()和Process32NextW()遍历全部进程句柄，GetModuleFileNameExW()获取进程路径。

## 13. 获取主机磁盘驱动器信息

相关函数：sub_41002B

![30.png](https://s2.loli.net/2022/01/26/ldDVbjCtTnEYo7I.png)

GetLogicalDriveStringsW()获取逻辑驱动器的根驱动器路径，GetDriveTypeW()获取驱动类型。

## 14. 获取主机中指定目录下的文件名

相关函数：sub_4073BB

![31.png](https://s2.loli.net/2022/01/26/OwoT1fFnkvKdNC2.png)

PathFindFileNameW()获取指定目录下的各个文件名。