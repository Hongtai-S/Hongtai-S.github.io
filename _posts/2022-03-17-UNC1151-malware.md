---
layout:     post
title:      恶意软件分析（八）：APT组织UNC1151样本分析
subtitle:   俄罗斯APT组织针对乌克兰的攻击
date:       2022-03-17
author:     Hongtai S
header-img: img/23.jpg
catalog: true
tags:
    - 逆向
    - 二进制
    - 恶意代码分析
    - APT
---
# 样本来源

在推特发现一篇疑似APT组织针对乌克兰的攻击样本：

![1.png](https://s2.loli.net/2022/03/17/tD5qM9zxZn4sA2i.png)

链接：[https://twitter.com/h2jazi/status/1500607147989684224](https://twitter.com/h2jazi/status/1500607147989684224)

# 样本信息

样本文件名：dovidka.chm

样本文件格式：chm

样本MD5：2556a9e1d5e9874171f51620e5c5e09a

样本SHA1：affc2b19d9fb8080a7211c3ed0718f2c3d3887df

样本SHA256：7f0511b09b1ab3a64c8827dd8af017acbf7d2688db31a5d98fea8a5029a89d56

# 样本分析

首先将样本文件解压，解压文件中包含htm文件：

![2.png](https://s2.loli.net/2022/03/17/3PC5zyacQ8bDHnL.png)

打开该htm文件查看代码，代码中包含了vbs脚本：

![3.png](https://s2.loli.net/2022/03/17/eqDSrzZWNFkJhVa.png)

代码将一段数据使用Unescape算法解密后写入文件，并执行该文件。将解密后的数据提取得到一段vbs代码：

![4.png](https://s2.loli.net/2022/03/17/bKpX4vIUF8s9iGf.png)

代码中的相关数据和字符串采用了翻转处理：

![5.png](https://s2.loli.net/2022/03/17/Rvx987aJSIsKYWl.png)

翻转的字符串：

![6.png](https://s2.loli.net/2022/03/17/oL6JWZFlk5YmsDu.png)

![7.png](https://s2.loli.net/2022/03/17/Ms64FlThwOckKjS.png)

脚本另外创建并写入了3个文件，分别是：

![8.png](https://s2.loli.net/2022/03/17/WBuRMOQPf76sJry.png)

![9.png](https://s2.loli.net/2022/03/17/S9NTl1QAafvHtVg.png)

![10.png](https://s2.loli.net/2022/03/17/xfmlJI53kVDXi4W.png)

释放的文件分别是core.dll、desktop.ini和Windows Prefetch.lnk。

Windows Prefetch.lnk用于启动desktop.ini，存放于自启动路径中：

![11.png](https://s2.loli.net/2022/03/17/Mk2zjPaBD8LRrcZ.png)

destop.ini用于启动core.dll：

![12.png](https://s2.loli.net/2022/03/17/N5rtYkS847GE9Tx.png)

core.dll文件是混淆的.net文件，经过解混淆处理查看代码：

![13.png](https://s2.loli.net/2022/03/17/BuokP1DGJ8d2lZv.png)

代码将两段数据解压后加载到内存中，分别是变量array2和array，加载到内存后创建线程，并将线程启动地址设置到分配的内存处。

变量array2解压后是一段加载dll的shellcode，用于加载变量array

![14.png](https://s2.loli.net/2022/03/17/UgDLc4NH3y5ka1j.png)

变量array解压后是dll文件：

![15.png](https://s2.loli.net/2022/03/17/jS2zZ5DFaAIXl9B.png)

导出array解压并修复导入表后查看其代码，程序首先创建互斥量，收集主机序列号和BIOS号并计算哈希值以唯一标识主机，随后通过证书机制验证程序是否被修改。

![16.png](https://s2.loli.net/2022/03/17/eaizouPpSC5lAc4.png)

连接相关的域名和端口：

![17.png](https://s2.loli.net/2022/03/17/lx5JytZBsMQCgmA.png)

解析的域名和端口号分别为xbeta[.]online和20FBh：

![18.png](https://s2.loli.net/2022/03/17/huLQBWRMX9PeIiw.png)

连接成功后接收恶意域名的指令：

![19.png](https://s2.loli.net/2022/03/17/VkwULxB3HzvQdAl.png)

根据接收的不同指令执行不同操作，首先逐个查找0x10005004处的字符串，出现匹配的字符串则执行相关函数：

![20.png](https://s2.loli.net/2022/03/17/J8LCTyeup31OwWn.png)

0x10005004处内容如下：

![21.png](https://s2.loli.net/2022/03/17/cnQXZrLVxFSR7Du.png)

该程序包含执行命令行、遍历系统文件路径、文件上传、文件下载、屏幕截图等功能。

# IOCs

MD5：
2556a9e1d5e9874171f51620e5c5e09a
a9dcaf1c709f96bc125c8d1262bac4b6
fb418bb5bd3e592651d0a4f9ae668962

C2：
xbeta[.]online