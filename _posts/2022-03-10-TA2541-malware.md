---
layout:     post
title:      恶意软件分析（六）：“TA2541”组织样本分析
subtitle:   针对航空领域的攻击
date:       2022-03-10
author:     Hongtai S
header-img: img/22.jpg
catalog: true
tags:
    - 逆向
    - 二进制
    - 恶意代码分析
---
# 事件背景

TA2541是一个运营了多年的黑客组织，至少自2017年以来一直活跃。该组织使用的诱饵主题包括与运输相关的术语，例如飞行、飞机、燃料、游艇、包机等。请求动态航班信息的电子邮件诱饵如下：

![1.png](https://s2.loli.net/2022/03/10/i7ZF3sqNOSlUHrz.png)

# 样本信息

样本文件名：694b021a6e7112383c16064569c99d35.bin

样本文件格式：vbs脚本，应该是从包含宏启动的恶意文档中提取出来的。

样本MD5：694b021a6e7112383c16064569c99d35

样本SHA1：214f3e1f42716ce8e2e6b59a35efc16465925346

样本SHA256：d793f37eb89310ddfc6d0337598c316db0eccda4d30e34143c768235594a169c

# 样本分析

查看样本代码，是经过混淆的vbs脚本：

![2.png](https://s2.loli.net/2022/03/10/gbr43sPHXKAkENZ.png)

通过解混淆得到样本想要执行的命令：

![3.png](https://s2.loli.net/2022/03/10/xKuvIFydbag4MhT.png)

样本从指定的链接（https://paste[.]ee/r/gk49i/0）下载并运行一个PowerShell脚本，该样本文件信息如下：

样本文件名：Handler64Bits.PS1

样本文件格式：PowerShell脚本

样本MD5：90622ca641a65e1b71783f6face7f4c6

样本SHA1：7bea3e5f38b24793edf53847dd1416dcd900f4bb

样本SHA256：bc3beb2ce29d965c215baf97c54cb321d7f579a7a6fe6a4992e4f1f5d8d51808

PowerShell脚本首先将自身安装至系统中，是通过在系统自启动的文件夹中创建vbs脚本的方式达到持久化。

![4.png](https://s2.loli.net/2022/03/10/Tlx8KqdmCwQegXo.png)

创建的vbs脚本的代码为：

![5.png](https://s2.loli.net/2022/03/10/3SquMQ8gjxX7y4k.png)

其中的%FilePath%为PowerShell脚本命令行的路径。

随后，PowerShell脚本解压并编译了一段代码

![6.png](https://s2.loli.net/2022/03/10/AV8Tvplig7uIZcb.png)

将解压后的代码导出，得到了一段C#代码，编译C#代码后，脚本调用了C#代码的GIT.Kamikazi类的Execute方法：

![7.png](https://s2.loli.net/2022/03/10/GFUVW4JNuZybMT6.png)

Execute方法的主要功能是创建进程并将传入的PE文件加载到该进程中：

![8.png](https://s2.loli.net/2022/03/10/SyCMn67ELdPofYl.png)
![9.png](https://s2.loli.net/2022/03/10/mTFM6EsGfxeK7lW.png)
![10.png](https://s2.loli.net/2022/03/10/bkQNwh7PKt42GHB.png)

传入的参数分别是：
路径字符串“C:\Windows\Microsoft.NET\Framework\v4.0.30319\InstallUtil.exe”和一段解压后未编码的数据：

![11.png](https://s2.loli.net/2022/03/10/yaYOj7rDipcfQoJ.png)

将样本编码后得到了一个.net文件：

![12.png](https://s2.loli.net/2022/03/10/ymBuh4XO5RlZkPf.png)

样本MD5：f0d162273209b16a3424d0ff53bfe199

样本SHA1: 2e3a923cbc4f2a7f0557e71edc06061ab04735b7

样本SHA256：a3c832933cb5e09ab12eac046acf31a3395ff59499192765b3c9a5534dcde72f

样本主函数功能如下：

![13.png](https://s2.loli.net/2022/03/10/mrLZhbBFRw1q8Vj.png)
![14.png](https://s2.loli.net/2022/03/10/kH7pTxuCKzRmXfA.png)

InitializeSettings()函数主要解密秘钥、回连域名和端口号、互斥量等数据，并验证数字证书：

![15.png](https://s2.loli.net/2022/03/10/G8upotV4zFY6iBR.png)

RunAntiAnalysis()通过查找是否有缓存内存判断是否是虚拟机环境：

![16.png](https://s2.loli.net/2022/03/10/GsR98EQaXVuN6Bv.png)

CreateMutex()创建了名为“DcRatMutex_qwqdanchun”的互斥量

![17.png](https://s2.loli.net/2022/03/10/HpeJ9NXPuF1LtGh.png)

StartBlock()函数检索系统中的进程，若遇到指定的进程名，则将其结束：

18![18.png](https://s2.loli.net/2022/03/10/T9Jui6woEk3ORAX.png)

Set()开启进程保护：

![19.png](https://s2.loli.net/2022/03/10/vzjBdF9uVhcwQea.png)

Install()函数主要首先判断是否有管理员权限，若有管理员权限则通过添加任务计划的方式实现自启动，启动方式为任何用户登录时启动：

![20.png](https://s2.loli.net/2022/03/10/KDBqZARpyL6XgNk.png)

若无管理员权限，则通过添加注册表添项实现自启动：

![21.png](https://s2.loli.net/2022/03/10/xIJhkHAEGDb9iq3.png)

Bypass()函数主要通过修改amsi.dll的AmsiScanBuffer()函数的二进制代码进而逃避安全监测。

![22.png](https://s2.loli.net/2022/03/10/eUmdi2CAMJ5LHTB.png)

InitializeClient()函数连接指定的ip和端口，并向其发送用户信息：

![23.png](https://s2.loli.net/2022/03/10/sjS6FzUAl8wtn4P.png)

域名、ip和端口号分别是："joelthomas.linkpc[.]net"、91.193.75.183和5900：

![24.png](https://s2.loli.net/2022/03/10/CVzb9jIm5qDRPwd.png)

连接后向该套接字发送主机信息，主要包括：用户名、操作系统版本信息、是否有摄像头设备、当前运行进程的路径、是都有管理员权限、当前活动窗口标题、计算机中反病毒软件等。

![25.png](https://s2.loli.net/2022/03/10/aMXPC1VieTwlY26.png)

域名"joelthomas.linkpc[.]net"在一篇Proofpoint的TA2541分析报告中出现，该地址正是报告中IOC的其中之一：

![26.png](https://s2.loli.net/2022/03/10/MtHC4Lil1mjnxqy.png)

在报告中描述的TA2541攻击流程与该样本的攻击流程基本吻合：

![27.png](https://s2.loli.net/2022/03/10/16mEPnfACu9Lswb.png)

# IOC

MD5：

694b021a6e7112383c16064569c99d35

90622ca641a65e1b71783f6face7f4c6

f0d162273209b16a3424d0ff53bfe199

ip：

91.193.75.183

url：

https://paste[.]ee/r/gk49i/0

joelthomas.linkpc[.]net
